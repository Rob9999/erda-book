#!/usr/bin/env python3
"""Generate the ERDA CC BY 4.0 compliant fallback CJK font."""

from __future__ import annotations

from typing import Dict, Iterable, List, Tuple

from fontTools.fontBuilder import FontBuilder
from fontTools.pens.ttGlyphPen import TTGlyphPen
from fontTools.ttLib.tables.O_S_2f_2 import Panose

EM = 1000
PIXELS = 8
CELL = EM // (PIXELS + 2)
MARGIN = CELL


def _glyph_from_bitmap(bitmap: List[str]) -> Tuple[object, int]:
    pen = TTGlyphPen(None)
    rows = len(bitmap)
    cols = len(bitmap[0]) if rows else 0
    for row_index, row in enumerate(bitmap):
        for col_index, bit in enumerate(row):
            if bit != "#":
                continue
            x = MARGIN + col_index * CELL
            y = MARGIN + (rows - 1 - row_index) * CELL
            _draw_rect(pen, x, y, CELL, CELL)
    glyph = pen.glyph()
    width = (cols + 2) * CELL
    return glyph, width


def _draw_rect(pen: TTGlyphPen, x: int, y: int, w: int, h: int) -> None:
    pen.moveTo((x, y))
    pen.lineTo((x + w, y))
    pen.lineTo((x + w, y + h))
    pen.lineTo((x, y + h))
    pen.closePath()


def _merge_bitmaps(*bitmaps: Iterable[List[str]]) -> List[str]:
    width = len(bitmaps[0][0])
    height = len(bitmaps[0])
    grid = [["." for _ in range(width)] for _ in range(height)]
    for bitmap in bitmaps:
        for y, row in enumerate(bitmap):
            for x, cell in enumerate(row):
                if cell == "#":
                    grid[y][x] = "#"
    return ["".join(row) for row in grid]


# Katakana base glyphs (8x8)
KATAKANA_BASE: Dict[str, List[str]] = {
    "ア": [
        "..####..",
        "....#...",
        "....#...",
        "...##...",
        "..#.#...",
        ".#..#...",
        "#...#...",
        "#...#...",
    ],
    "イ": [
        "...##...",
        "....#...",
        "....#...",
        "....#...",
        "....#...",
        "..##....",
        "##......",
        "#.......",
    ],
    "ウ": [
        "..####..",
        "....#...",
        "....#...",
        "..####..",
        "..#..#..",
        "..#..#..",
        "..#..#..",
        "..####..",
    ],
    "エ": [
        "########",
        "#.......",
        "#.......",
        "#####...",
        "#.......",
        "#.......",
        "#.......",
        "########",
    ],
    "オ": [
        "#######.",
        ".....#..",
        ".....#..",
        "..#####.",
        "..#..#..",
        "..#..#..",
        "..#..#..",
        "..####..",
    ],
    "カ": [
        "#######.",
        ".....#..",
        "....#...",
        "...#....",
        "..#.....",
        ".#..#...",
        "#....#..",
        "#.....#.",
    ],
    "キ": [
        "########",
        "....#...",
        "....#...",
        "########",
        "....#...",
        "....#...",
        "....#...",
        "########",
    ],
    "ク": [
        "..####..",
        "....#...",
        "....#...",
        "...#....",
        "..#.....",
        ".#......",
        "#.......",
        "#.......",
    ],
    "ケ": [
        "#######.",
        "....#...",
        "...#....",
        "..#####.",
        "..#.....",
        "..#.....",
        "..#.....",
        "..#.....",
    ],
    "コ": [
        "########",
        ".......#",
        ".......#",
        ".......#",
        ".......#",
        ".......#",
        ".......#",
        "########",
    ],
    "サ": [
        "########",
        "....#...",
        "....#...",
        "########",
        "..#.....",
        "..#.....",
        "..#.....",
        "..#.....",
    ],
    "シ": [
        "...####.",
        ".....#..",
        ".....#..",
        "..###...",
        "..#.....",
        "..#.....",
        "..#.....",
        "..#.....",
    ],
    "ス": [
        "########",
        ".....#..",
        "....#...",
        "...#....",
        "..#.....",
        ".#......",
        "#.......",
        "########",
    ],
    "セ": [
        "#######.",
        "....#...",
        "....#...",
        "########",
        "....#...",
        "....#...",
        "#...#...",
        "#...#...",
    ],
    "ソ": [
        "...####.",
        "....#...",
        "....#...",
        "...#....",
        "..#.....",
        ".#......",
        "#.......",
        "#.......",
    ],
    "タ": [
        "########",
        "....#...",
        "....#...",
        "########",
        "..#.....",
        "..#.....",
        "..#.....",
        "..#.....",
    ],
    "チ": [
        "########",
        ".....#..",
        ".....#..",
        "..####..",
        "..#..#..",
        "..#..#..",
        "..#..#..",
        "..####..",
    ],
    "ツ": [
        "...####.",
        "....#...",
        "....#...",
        "..###...",
        "..#.....",
        "..#.....",
        "..#.....",
        "..####..",
    ],
    "テ": [
        "########",
        "....#...",
        "....#...",
        "########",
        "....#...",
        "....#...",
        "....#...",
        "....#...",
    ],
    "ト": [
        "....###.",
        ".....#..",
        ".....#..",
        ".....#..",
        ".....#..",
        ".....#..",
        ".....#..",
        "########",
    ],
    "ナ": [
        "#######.",
        "....#...",
        "....#...",
        "....#...",
        "....#...",
        "....#...",
        "#...#...",
        "#...#...",
    ],
    "ニ": [
        "########",
        "........",
        "........",
        "########",
        "........",
        "........",
        "........",
        "########",
    ],
    "ノ": [
        ".....##",
        "....#..",
        "...#...",
        "..#....",
        ".#.....",
        "#......",
        "#......",
        "#......",
    ],
    "ハ": [
        "#......#",
        "#......#",
        ".#....#.",
        "..#..#..",
        "...##...",
        "....#...",
        "....#...",
        "....#...",
    ],
    "ヒ": [
        "#......#",
        "#......#",
        "#......#",
        "########",
        "....#...",
        "....#...",
        "....#...",
        "....#...",
    ],
    "フ": [
        "....###.",
        ".....#..",
        ".....#..",
        ".....#..",
        ".....#..",
        ".....#..",
        "#####...",
        "#.......",
    ],
    "ヘ": [
        "#......#",
        ".#....#.",
        "..#..#..",
        "...##...",
        "....#...",
        "....#...",
        "....#...",
        "....#...",
    ],
    "マ": [
        "########",
        "....#...",
        "...#....",
        "..#.....",
        ".#......",
        "#.......",
        "#.......",
        "#.......",
    ],
    "ミ": [
        "########",
        "........",
        "..####..",
        "........",
        "..####..",
        "........",
        "..####..",
        "........",
    ],
    "ム": [
        "#######.",
        "....#...",
        "...#....",
        "..#.....",
        ".#......",
        "#.......",
        "#.......",
        "#.......",
    ],
    "メ": [
        "#......#",
        ".#....#.",
        "..#..#..",
        "...##...",
        "....#...",
        "...##...",
        "..#..#..",
        ".#....#.",
    ],
    "モ": [
        "########",
        "....#...",
        "....#...",
        "########",
        "....#...",
        "....#...",
        "########",
        "........",
    ],
    "ヤ": [
        "#......#",
        ".#....#.",
        "..#..#..",
        "...##...",
        "....#...",
        "....#...",
        "....#...",
        "....#...",
    ],
    "ユ": [
        "########",
        "#......#",
        "#......#",
        "########",
        "#......#",
        "#......#",
        "########",
        "........",
    ],
    "ヨ": [
        "########",
        "#......#",
        "#......#",
        "########",
        "#......#",
        "#......#",
        "########",
        "........",
    ],
    "ラ": [
        "########",
        "....#...",
        "....#...",
        "...#....",
        "..#.....",
        ".#......",
        "#.......",
        "########",
    ],
    "リ": [
        "#......#",
        "#......#",
        "#......#",
        "#......#",
        "#......#",
        "#......#",
        "#......#",
        "########",
    ],
    "ル": [
        "#.......",
        "#.......",
        "#.......",
        "#.......",
        "#.......",
        "#...#...",
        "#....#..",
        "#.....#.",
    ],
    "レ": [
        ".....##",
        "....#..",
        "...#...",
        "..#....",
        ".#.....",
        "#......",
        "#......",
        "#......",
    ],
    "ロ": [
        "########",
        "#......#",
        "#......#",
        "#......#",
        "#......#",
        "#......#",
        "#......#",
        "########",
    ],
    "ワ": [
        "########",
        ".....#..",
        "....#...",
        "...#....",
        "..#.....",
        ".#......",
        "#.......",
        "#.......",
    ],
    "ヲ": [
        "########",
        ".....#..",
        "....#...",
        "...#....",
        "..####..",
        "....#...",
        "....#...",
        "########",
    ],
    "ン": [
        "#.......",
        "#.......",
        "#.......",
        "#....#..",
        "#...#...",
        "#..#....",
        "#.#.....",
        "##......",
    ],
    "ー": [
        "........",
        "........",
        "........",
        "........",
        "########",
        "........",
        "........",
        "........",
    ],
}

SMALL_KATAKANA: Dict[str, List[str]] = {
    "ッ": [
        "........",
        "...###..",
        "....#...",
        "....#...",
        "..##....",
        "..#.....",
        "..#.....",
        "........",
    ],
    "ャ": [
        "#...#...",
        ".#.#....",
        "..##....",
        "...#....",
        "...#....",
        "...#....",
        "........",
        "........",
    ],
    "ュ": [
        "######..",
        "#...#...",
        "######..",
        "#...#...",
        "######..",
        "........",
        "........",
        "........",
    ],
    "ョ": [
        "######..",
        "#...#...",
        "######..",
        "#...#...",
        "######..",
        "........",
        "........",
        "........",
    ],
    "ェ": [
        "######..",
        "#.......",
        "#####...",
        "#.......",
        "#.......",
        "######..",
        "........",
        "........",
    ],
}

DAKUTEN = [
    "#.#.....",
    ".#.#....",
    "........",
    "........",
    "........",
    "........",
    "........",
    "........",
]

HANDAKUTEN = [
    ".###....",
    "#...#...",
    "#...#...",
    ".###....",
    "........",
    "........",
    "........",
    "........",
]

DAKUTEN_COMBOS = {
    "ガ": "カ",
    "ギ": "キ",
    "グ": "ク",
    "ゲ": "ケ",
    "ゴ": "コ",
    "ザ": "サ",
    "ジ": "シ",
    "ズ": "ス",
    "ゼ": "セ",
    "ゾ": "ソ",
    "ダ": "タ",
    "ヂ": "チ",
    "ヅ": "ツ",
    "デ": "テ",
    "ド": "ト",
    "バ": "ハ",
    "ビ": "ヒ",
    "ブ": "フ",
    "ベ": "ヘ",
    "ボ": "ホ",
}

HANDAKUTEN_COMBOS = {
    "パ": "ハ",
    "ピ": "ヒ",
    "プ": "フ",
    "ペ": "ヘ",
    "ポ": "ホ",
}

PUNCTUATION = {
    "、": [
        "........",
        "........",
        "........",
        "........",
        "........",
        "..##....",
        "..##....",
        "..#.....",
    ],
    "。": [
        "........",
        "........",
        "........",
        "........",
        "...##...",
        "..#..#..",
        "..#..#..",
        "...##...",
    ],
    "・": [
        "........",
        "........",
        "........",
        "...##...",
        "...##...",
        "........",
        "........",
        "........",
    ],
    ",": [
        "........",
        "........",
        "........",
        "........",
        "........",
        "..##....",
        "..##....",
        "..#.....",
    ],
    ".": [
        "........",
        "........",
        "........",
        "........",
        "........",
        "..##....",
        "..##....",
        "........",
    ],
}

# Hangul pattern definitions (4x4)
L_PATTERNS = {
    "ㄱ": [
        "####",
        "#...",
        "#...",
        "#...",
    ],
    "ㄲ": [
        "#..#",
        "#..#",
        "#..#",
        "#..#",
    ],
    "ㄴ": [
        "#...",
        "#...",
        "#...",
        "####",
    ],
    "ㄷ": [
        "####",
        "#..#",
        "#..#",
        "####",
    ],
    "ㄸ": [
        "####",
        "#..#",
        "#..#",
        "#..#",
    ],
    "ㄹ": [
        "####",
        "#..#",
        "####",
        "#..#",
    ],
    "ㅁ": [
        "####",
        "#..#",
        "#..#",
        "####",
    ],
    "ㅂ": [
        "#..#",
        "####",
        "#..#",
        "####",
    ],
    "ㅃ": [
        "#..#",
        "####",
        "#..#",
        "#..#",
    ],
    "ㅅ": [
        "#..#",
        ".#.#",
        "..#.",
        "..#.",
    ],
    "ㅆ": [
        "#..#",
        ".#.#",
        "#..#",
        "..#.",
    ],
    "ㅇ": [
        ".##.",
        "#..#",
        "#..#",
        ".##.",
    ],
    "ㅈ": [
        "####",
        "..#.",
        "..#.",
        "..#.",
    ],
    "ㅉ": [
        "####",
        "..#.",
        "####",
        "..#.",
    ],
    "ㅊ": [
        "#..#",
        "####",
        "..#.",
        "..#.",
    ],
    "ㅋ": [
        "####",
        "#..#",
        "#.#.",
        "#..#",
    ],
    "ㅌ": [
        "####",
        "#..#",
        "####",
        "..#.",
    ],
    "ㅍ": [
        "####",
        "#..#",
        "####",
        "#..#",
    ],
    "ㅎ": [
        "####",
        "#..#",
        "####",
        "..#.",
    ],
}

V_PATTERNS = {
    "ㅏ": [
        ".#..",
        ".#..",
        ".#..",
        "###.",
    ],
    "ㅐ": [
        "##.#",
        "..#.",
        "..#.",
        "##.#",
    ],
    "ㅑ": [
        ".#.#",
        ".#.#",
        ".#.#",
        "###.",
    ],
    "ㅒ": [
        "##.#",
        "..#.",
        "##.#",
        "##.#",
    ],
    "ㅓ": [
        "..#.",
        "..#.",
        "..#.",
        ".###",
    ],
    "ㅔ": [
        "#.##",
        "..#.",
        "..#.",
        "#.##",
    ],
    "ㅕ": [
        "..#.",
        "..#.",
        "..#.",
        ".#.#",
    ],
    "ㅖ": [
        "#.##",
        "..#.",
        "#.##",
        "#.##",
    ],
    "ㅗ": [
        "####",
        "..#.",
        "..#.",
        "..#.",
    ],
    "ㅘ": [
        "####",
        "..#.",
        "###.",
        "..#.",
    ],
    "ㅙ": [
        "####",
        "..#.",
        "##.#",
        "..#.",
    ],
    "ㅚ": [
        "####",
        "..#.",
        "..#.",
        "##.#",
    ],
    "ㅛ": [
        "#..#",
        "####",
        "..#.",
        "..#.",
    ],
    "ㅜ": [
        "..#.",
        "..#.",
        "####",
        "..#.",
    ],
    "ㅝ": [
        "..#.",
        "..#.",
        "###.",
        "..#.",
    ],
    "ㅞ": [
        "..#.",
        "..#.",
        "##.#",
        "..#.",
    ],
    "ㅟ": [
        "..#.",
        "..#.",
        "..#.",
        "##.#",
    ],
    "ㅠ": [
        "..#.",
        "..#.",
        "####",
        "#..#",
    ],
    "ㅡ": [
        "....",
        "####",
        "....",
        "....",
    ],
    "ㅢ": [
        "####",
        "..#.",
        "####",
        "..#.",
    ],
    "ㅣ": [
        "..#.",
        "..#.",
        "..#.",
        "..#.",
    ],
}

T_PATTERNS = {
    "": [
        "....",
        "....",
        "....",
        "....",
    ],
    "ㄱ": [
        "####",
        "#...",
        "#...",
        "#...",
    ],
    "ㄲ": [
        "#..#",
        "#..#",
        "#..#",
        "#..#",
    ],
    "ㄳ": [
        "#..#",
        "#.#.",
        "#..#",
        "#..#",
    ],
    "ㄴ": [
        "#...",
        "#...",
        "#...",
        "####",
    ],
    "ㄵ": [
        "#..#",
        "#..#",
        "#..#",
        "####",
    ],
    "ㄶ": [
        "#..#",
        "#..#",
        "####",
        "#..#",
    ],
    "ㄷ": [
        "####",
        "#..#",
        "#..#",
        "####",
    ],
    "ㄹ": [
        "####",
        "#..#",
        "####",
        "#..#",
    ],
    "ㄺ": [
        "####",
        "#..#",
        "####",
        "#...",
    ],
    "ㄻ": [
        "####",
        "#..#",
        "####",
        "####",
    ],
    "ㄼ": [
        "####",
        "#..#",
        "####",
        "#.#.",
    ],
    "ㄽ": [
        "####",
        "#..#",
        "####",
        "..#.",
    ],
    "ㄾ": [
        "####",
        "#..#",
        "####",
        "#.##",
    ],
    "ㄿ": [
        "####",
        "#..#",
        "####",
        "#..#",
    ],
    "ㅀ": [
        "####",
        "#..#",
        "####",
        "..#.",
    ],
    "ㅁ": [
        "####",
        "#..#",
        "#..#",
        "####",
    ],
    "ㅂ": [
        "#..#",
        "####",
        "#..#",
        "####",
    ],
    "ㅄ": [
        "#..#",
        "####",
        "#..#",
        "#.##",
    ],
    "ㅅ": [
        "#..#",
        ".#.#",
        "..#.",
        "..#.",
    ],
    "ㅆ": [
        "#..#",
        ".#.#",
        "#..#",
        "..#.",
    ],
    "ㅇ": [
        ".##.",
        "#..#",
        "#..#",
        ".##.",
    ],
    "ㅈ": [
        "####",
        "..#.",
        "..#.",
        "..#.",
    ],
    "ㅊ": [
        "#..#",
        "####",
        "..#.",
        "..#.",
    ],
    "ㅋ": [
        "####",
        "#..#",
        "#.#.",
        "#..#",
    ],
    "ㅌ": [
        "####",
        "#..#",
        "####",
        "..#.",
    ],
    "ㅍ": [
        "####",
        "#..#",
        "####",
        "#..#",
    ],
    "ㅎ": [
        "####",
        "#..#",
        "####",
        "..#.",
    ],
}

L_LIST = [
    "ㄱ",
    "ㄲ",
    "ㄴ",
    "ㄷ",
    "ㄸ",
    "ㄹ",
    "ㅁ",
    "ㅂ",
    "ㅃ",
    "ㅅ",
    "ㅆ",
    "ㅇ",
    "ㅈ",
    "ㅉ",
    "ㅊ",
    "ㅋ",
    "ㅌ",
    "ㅍ",
    "ㅎ",
]

V_LIST = [
    "ㅏ",
    "ㅐ",
    "ㅑ",
    "ㅒ",
    "ㅓ",
    "ㅔ",
    "ㅕ",
    "ㅖ",
    "ㅗ",
    "ㅘ",
    "ㅙ",
    "ㅚ",
    "ㅛ",
    "ㅜ",
    "ㅝ",
    "ㅞ",
    "ㅟ",
    "ㅠ",
    "ㅡ",
    "ㅢ",
    "ㅣ",
]

T_LIST = [
    "",
    "ㄱ",
    "ㄲ",
    "ㄳ",
    "ㄴ",
    "ㄵ",
    "ㄶ",
    "ㄷ",
    "ㄹ",
    "ㄺ",
    "ㄻ",
    "ㄼ",
    "ㄽ",
    "ㄾ",
    "ㄿ",
    "ㅀ",
    "ㅁ",
    "ㅂ",
    "ㅄ",
    "ㅅ",
    "ㅆ",
    "ㅇ",
    "ㅈ",
    "ㅊ",
    "ㅋ",
    "ㅌ",
    "ㅍ",
    "ㅎ",
]

SBASE = 0xAC00


def _bitmap_for_hangul(char: str) -> List[str]:
    code = ord(char)
    if not (0xAC00 <= code <= 0xD7A3):
        raise ValueError(f"Unsupported Hangul syllable: {char}")
    index = code - SBASE
    l_index = index // 588
    v_index = (index % 588) // 28
    t_index = index % 28
    l_jamo = L_LIST[l_index]
    v_jamo = V_LIST[v_index]
    t_jamo = T_LIST[t_index]

    grid = [["." for _ in range(8)] for _ in range(8)]

    def stamp(pattern: List[str], x_offset: int, y_offset: int) -> None:
        for y, row in enumerate(pattern):
            for x, val in enumerate(row):
                if val == "#":
                    gx = x_offset + x
                    gy = y_offset + y
                    if 0 <= gx < 8 and 0 <= gy < 8:
                        grid[gy][gx] = "#"

    vertical_vowels = {"ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅣ"}
    horizontal_vowels = {"ㅗ", "ㅛ", "ㅜ", "ㅠ", "ㅡ"}

    if v_jamo in vertical_vowels:
        stamp(L_PATTERNS[l_jamo], 0, 1)
        stamp(V_PATTERNS[v_jamo], 4, 1)
    elif v_jamo in horizontal_vowels:
        stamp(L_PATTERNS[l_jamo], 1, 0)
        stamp(V_PATTERNS[v_jamo], 1, 4)
    else:
        stamp(L_PATTERNS[l_jamo], 0, 0)
        stamp(V_PATTERNS[v_jamo], 3, 3)

    if t_jamo:
        stamp(T_PATTERNS[t_jamo], 2, 4)

    return ["".join(row) for row in grid]


JAPANESE_TRANSLATION = """
コノサクヒンノリヨウ・カコウ・ヘンカンハ、ジンコウチノウ、キカイガクシュウ、ソノタノジドウカシステムニヨルモノヲフクメ、スベテオナジオープンライセンスノジョウケンニシタガイマス。コレハハセイサクヒン、エーアイガセイセイシタコンテンツ、リミックスプロジェクト、アルゴリズムニヨッテヘンカンサレタケイシキヲメイシテキニフクミマス。モクテキハ、ミンシュテキデソウゾウテキカツタヨウナシャカイニオケル、キョウユウサレヒラカレタチノショウライデス。
""".strip()

KOREAN_TRANSLATION = """
이 자료의 사용과 변경은 모든 공개 허가 조건을 그대로 따릅니다. 인공지능이나 자동 시스템을 써도 같습니다. 파생 자료, 에이아이 생성 내용, 리믹스 프로젝트, 알고 절차로 바꾼 형식도 모두 포함합니다. 목표는 민주 사회 안에서 함께 여는 지식의 미래입니다.
""".strip()


def _collect_characters(*texts: str) -> List[str]:
    required: set[str] = set()
    for text in texts:
        for char in text:
            if char in {"\n", "\r"}:
                continue
            if char == " ":
                continue
            required.add(char)
    return sorted(required)


REQUIRED_CHARS = _collect_characters(JAPANESE_TRANSLATION, KOREAN_TRANSLATION)


def build_font(output: str = "erda_ccby_cjk.ttf") -> None:
    glyph_order = [".notdef", "space"]
    glyphs: Dict[str, object] = {}
    advance_widths: Dict[str, Tuple[int, int]] = {}
    cmap: Dict[int, str] = {32: "space"}

    notdef_glyph, notdef_width = _glyph_from_bitmap([
        "########",
        "########",
        "########",
        "########",
        "########",
        "########",
        "########",
        "########",
    ])
    glyphs[".notdef"] = notdef_glyph
    advance_widths[".notdef"] = (notdef_width, 0)

    space_glyph, space_width = _glyph_from_bitmap(["........"] * 8)
    glyphs["space"] = space_glyph
    advance_widths["space"] = (space_width, 0)

    def add_char(char: str, bitmap: List[str]) -> None:
        name = f"uni{ord(char):04X}"
        if name in glyphs:
            return
        glyph, width = _glyph_from_bitmap(bitmap)
        glyph_order.append(name)
        glyphs[name] = glyph
        advance_widths[name] = (width, 0)
        cmap[ord(char)] = name

    for char in REQUIRED_CHARS:
        if char in KATAKANA_BASE:
            add_char(char, KATAKANA_BASE[char])
            continue
        if char in SMALL_KATAKANA:
            add_char(char, SMALL_KATAKANA[char])
            continue
        if char in DAKUTEN_COMBOS:
            base = KATAKANA_BASE[DAKUTEN_COMBOS[char]]
            add_char(char, _merge_bitmaps(base, DAKUTEN))
            continue
        if char in HANDAKUTEN_COMBOS:
            base = KATAKANA_BASE[HANDAKUTEN_COMBOS[char]]
            add_char(char, _merge_bitmaps(base, HANDAKUTEN))
            continue
        if char in PUNCTUATION:
            add_char(char, PUNCTUATION[char])
            continue
        if char == "ー":
            add_char(char, KATAKANA_BASE["ー"])
            continue
        code = ord(char)
        if 0xAC00 <= code <= 0xD7A3:
            add_char(char, _bitmap_for_hangul(char))
            continue
        raise ValueError(f"Unsupported character {char!r}")

    ascent = int(EM * 0.8)
    descent = -int(EM * 0.2)

    fb = FontBuilder(EM, isTTF=True)
    fb.setupGlyphOrder(glyph_order)
    fb.setupCharacterMap(cmap)
    fb.setupGlyf(glyphs)
    fb.setupHorizontalMetrics(advance_widths)
    fb.setupHorizontalHeader(ascent=ascent, descent=descent)
    panose = Panose()
    panose.bFamilyType = 2
    panose.bSerifStyle = 11
    panose.bWeight = 5
    panose.bProportion = 9
    panose.bContrast = 3
    panose.bStrokeVariation = 9
    panose.bArmStyle = 2
    panose.bLetterForm = 3
    panose.bMidline = 2
    panose.bXHeight = 4
    fb.setupOS2(
        sTypoAscender=ascent,
        sTypoDescender=descent,
        sTypoLineGap=200,
        usWinAscent=ascent,
        usWinDescent=-descent,
        bFamilyClass=0,
        panose=panose,
        ulUnicodeRange1=0x00000001,
        ulUnicodeRange2=0x00000000,
        ulUnicodeRange3=0x00000000,
        ulUnicodeRange4=0x00000000,
        fsSelection=0x40,
        usWeightClass=400,
        usWidthClass=5,
        ySubscriptXSize=650,
        ySubscriptYSize=699,
        ySubscriptXOffset=0,
        ySubscriptYOffset=140,
        ySuperscriptXSize=650,
        ySuperscriptYSize=699,
        ySuperscriptXOffset=0,
        ySuperscriptYOffset=479,
        yStrikeoutSize=50,
        yStrikeoutPosition=250,
        sxHeight=500,
        sCapHeight=700,
    )
    fb.setupNameTable(
        {
            "familyName": "ERDA CC-BY CJK",
            "styleName": "Regular",
            "psName": "ERDACCbyCJK-Regular",
            "fullName": "ERDA CC-BY CJK Regular",
            "uniqueFontIdentifier": "ERDA CC-BY CJK Regular",
            "version": "Version 1.0",
        }
    )
    fb.setupPost()
    fb.setupMaxp()
    fb.save(output)


if __name__ == "__main__":
    build_font()
